FROM node:22-slim

WORKDIR /app

# Copy root package files
COPY package.json pnpm-workspace.yaml ./

# Copy only what the migrator needs
COPY packages/config/package.json packages/config/
COPY packages/db/package.json packages/db/
COPY scripts/ scripts/
COPY db/ db/
COPY tsconfig.base.json ./

# Install pnpm and dependencies
RUN npm install -g pnpm && pnpm install --no-frozen-lockfile

CMD ["npx", "tsx", "scripts/run-migrations.ts"]
